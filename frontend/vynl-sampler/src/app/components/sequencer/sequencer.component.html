<!-- src/app/components/sequencer/sequencer.component.html -->

<div class="sequencer-container bg-gradient-to-br from-vynl-cloud to-vynl-silver p-4 rounded-2xl">
  
  <!-- 🎚️ Header Compacto -->
  <div class="transport-header glass backdrop-blur-xl border border-white/20 rounded-xl p-3 mb-4">
    <div class="flex items-center justify-between">
      
      <!-- ▶️ Controles Básicos -->
      <div class="transport-controls flex items-center gap-3">
        <button (click)="togglePlayback()"
                class="play-button w-10 h-10 rounded-lg flex items-center justify-center transition-colors duration-75"
                [ngClass]="playbackState().isPlaying ? 'bg-vynl-carbon text-vynl-white' : 'bg-vynl-white text-vynl-carbon'">
          <span class="text-sm font-bold">{{ playbackState().isPlaying ? 'STOP' : 'PLAY' }}</span>
        </button>

        <div class="bpm-control flex items-center gap-2">
          <label class="text-vynl-carbon font-bold text-sm">BPM</label>
          <input type="number" min="60" max="200" [(ngModel)]="tempBPM" (change)="updateBPM()"
                 class="w-14 h-7 bg-vynl-white/80 border border-vynl-slate rounded-lg text-center text-sm font-mono focus:outline-none focus:ring-1 focus:ring-vynl-carbon">
        </div>

        <div class="step-indicator flex items-center gap-2">
          <label class="text-vynl-carbon font-bold text-sm">STEP</label>
          <div class="w-7 h-7 bg-vynl-carbon text-vynl-white rounded-lg flex items-center justify-center text-sm font-mono">
            {{ playbackState().currentStep + 1 }}
          </div>
        </div>
      </div>

      <!-- 🎚️ Controles Globales Compactos -->
      <div class="global-controls flex items-center gap-4">
        <div class="swing-control flex flex-col items-center">
          <label class="text-xs text-vynl-charcoal font-bold mb-1">SWING</label>
          <input type="range" min="0" max="100" [(ngModel)]="tempSwing" (input)="updateSwing()"
                 class="w-12 h-2 bg-vynl-slate rounded-full">
          <div class="text-xs text-vynl-charcoal mt-1">{{ tempSwing() }}%</div>
        </div>

        <button (click)="showAdvancedControls.set(!showAdvancedControls())"
                class="advanced-toggle px-3 py-1 bg-vynl-white/80 text-vynl-carbon rounded-lg text-xs font-bold transition-colors duration-75">
          {{ showAdvancedControls() ? 'SIMPLE' : 'ADV' }}
        </button>
      </div>
    </div>
  </div>

  <!-- 🎹 Grid Principal Compacto -->
  <div class="sequencer-grid glass backdrop-blur-xl border border-white/20 rounded-xl overflow-hidden">
    
    <!-- Header con números de steps -->
    <div class="grid-header bg-vynl-white/50 border-b border-vynl-slate/30 p-2">
      <div class="flex">
        <div class="w-32 flex items-center justify-center">
          <span class="text-vynl-carbon font-bold text-sm">TRACKS</span>
        </div>
        <div class="flex-1 grid grid-cols-16 gap-1">
          @for (step of getStepNumbers(); track step) {
            <div class="step-header h-6 flex items-center justify-center text-xs font-mono text-vynl-charcoal font-bold"
                 [class.current-step]="playbackState().currentStep === step - 1">
              {{ step }}
            </div>
          }
        </div>
      </div>
    </div>

    <!-- Track Rows Compactas -->
    <div class="tracks-container max-h-80 overflow-y-auto">
      @for (track of currentPattern().tracks; track track.id) {
        <div class="track-row border-b border-vynl-slate/20 transition-colors duration-75"
             [ngClass]="getTrackClass(track)">
          
          <div class="flex">
            <!-- Track Info Compacta -->
            <div class="track-info w-32 p-2 bg-vynl-white/20 flex items-center justify-between">
              <div class="track-details flex items-center gap-1">
                <div class="pad-indicator w-5 h-5 rounded flex items-center justify-center text-xs font-bold text-vynl-white"
                     [style.background-color]="track.color">
                  {{ track.padIndex + 1 }}
                </div>
                <div class="track-name text-sm font-bold text-vynl-carbon truncate">
                  {{ track.name }}
                </div>
              </div>

              <div class="track-buttons flex items-center gap-1">
                <button (click)="onMuteToggle(track.id)"
                        class="w-5 h-5 rounded text-xs font-bold transition-colors duration-75"
                        [ngClass]="track.mute ? 'bg-vynl-carbon text-vynl-white' : 'bg-vynl-slate/50 text-vynl-charcoal'">
                  M
                </button>
                <button (click)="onSoloToggle(track.id)"
                        class="w-5 h-5 rounded text-xs font-bold transition-colors duration-75"
                        [ngClass]="track.solo ? 'bg-vynl-carbon text-vynl-white' : 'bg-vynl-slate/50 text-vynl-charcoal'">
                  S
                </button>
              </div>
            </div>

            <!-- Step Grid Compacto -->
            <div class="steps-grid flex-1 p-2 grid grid-cols-16 gap-1">
              @for (step of track.steps; track $index) {
                <button class="step-button relative w-6 h-6 rounded transition-none focus:outline-none"
                        [ngClass]="{
                          'step-active': step.isActive,
                          'step-inactive': !step.isActive,
                          'current-playback': playbackState().currentStep === $index && playbackState().isPlaying,
                          'step-selected': selectedStep() === $index && selectedTrack() === track.id
                        }"
                        [style.background-color]="step.isActive ? track.color : 'transparent'"
                        [style.opacity]="step.isActive ? (step.velocity / 127) : 0.3"
                        (click)="onStepClick(track.id, $index, $event)"
                        (wheel)="onStepWheel(track.id, $index, $event)">
                </button>
              }
            </div>
          </div>
        </div>
      }
    </div>
  </div>

  <!-- 🎚️ Advanced Controls Panel - Solo cuando es necesario -->
  @if (showAdvancedControls() && selectedTrackData() && selectedStepData()) {
    <div class="advanced-panel glass backdrop-blur-xl border border-white/20 rounded-2xl p-6 mt-6">
      
      <h3 class="text-vynl-carbon text-lg font-bold mb-4">
        ADVANCED - {{ selectedTrackData()!.name }} Step {{ selectedStep()! + 1 }}
      </h3>

      <div class="controls-grid grid grid-cols-2 md:grid-cols-4 gap-6">
        
        <!-- 🎚️ Velocity -->
        <div class="control-group">
          <label class="block text-sm font-bold text-vynl-carbon mb-2">VELOCITY</label>
          <input 
            type="range" 
            min="0" 
            max="127" 
            [value]="selectedStepData()!.velocity"
            (input)="sequencerService.updateStepVelocity(selectedTrackData()!.id, selectedStep()!, +$any($event.target).value)"
            class="w-full h-2 bg-vynl-slate rounded-full">
          <div class="text-xs text-vynl-charcoal mt-1 text-center">{{ selectedStepData()!.velocity }}/127</div>
        </div>

        <!-- 🎯 Pan -->
        <div class="control-group">
          <label class="block text-sm font-bold text-vynl-carbon mb-2">PAN</label>
          <input 
            type="range" 
            min="-100" 
            max="100" 
            [value]="selectedStepData()!.pan * 100"
            (input)="sequencerService.updateStepPan(selectedTrackData()!.id, selectedStep()!, +$any($event.target).value / 100)"
            class="w-full h-2 bg-vynl-slate rounded-full">
          <div class="text-xs text-vynl-charcoal mt-1 text-center">
            {{ selectedStepData()!.pan > 0 ? 'R' : selectedStepData()!.pan < 0 ? 'L' : 'C' }}{{ Math.abs(selectedStepData()!.pan * 100).toFixed(0) }}
          </div>
        </div>

        <!-- 🎲 Probability -->
        <div class="control-group">
          <label class="block text-sm font-bold text-vynl-carbon mb-2">CHANCE</label>
          <input 
            type="range" 
            min="0" 
            max="100" 
            [value]="selectedStepData()!.probability"
            class="w-full h-2 bg-vynl-slate rounded-full">
          <div class="text-xs text-vynl-charcoal mt-1 text-center">{{ selectedStepData()!.probability }}%</div>
        </div>

        <!-- ⏱️ Note Length -->
        <div class="control-group">
          <label class="block text-sm font-bold text-vynl-carbon mb-2">LENGTH</label>
          <input 
            type="range" 
            min="10" 
            max="400" 
            [value]="selectedStepData()!.noteLength * 100"
            class="w-full h-2 bg-vynl-slate rounded-full">
          <div class="text-xs text-vynl-charcoal mt-1 text-center">{{ (selectedStepData()!.noteLength * 100).toFixed(0) }}%</div>
        </div>
      </div>

      <!-- 🎵 Advanced Options Row -->
      <div class="advanced-options mt-6 flex items-center gap-6">
        
        <!-- 🎼 Triplet Toggle -->
        <div class="triplet-control">
          <label class="flex items-center gap-2 cursor-pointer">
            <input 
              type="checkbox" 
              [checked]="selectedStepData()!.triplet"
              class="w-4 h-4">
            <span class="text-sm font-bold text-vynl-carbon">TRIPLET</span>
          </label>
        </div>

        <!-- 🎚️ Step Humanize -->
        <div class="humanize-control flex items-center gap-3">
          <label class="text-sm font-bold text-vynl-carbon">HUMANIZE</label>
          <input 
            type="range" 
            min="0" 
            max="100" 
            [value]="selectedStepData()!.humanize"
            class="w-24 h-2 bg-vynl-slate rounded-full">
          <span class="text-xs text-vynl-charcoal w-8">{{ selectedStepData()!.humanize }}%</span>
        </div>

        <!-- 🎵 Step Swing -->
        <div class="swing-control flex items-center gap-3">
          <label class="text-sm font-bold text-vynl-carbon">SWING</label>
          <input 
            type="range" 
            min="0" 
            max="100" 
            [value]="selectedStepData()!.swing"
            class="w-24 h-2 bg-vynl-slate rounded-full">
          <span class="text-xs text-vynl-charcoal w-8">{{ selectedStepData()!.swing }}%</span>
        </div>
      </div>
    </div>
  }
</div>