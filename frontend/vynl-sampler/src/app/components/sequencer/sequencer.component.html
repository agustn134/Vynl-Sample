<!-- sequencer.component.html - PRODUCER UX EDITION -->
<div class="sequencer-container glass-fast border border-white/20 rounded-2xl p-6 shadow-soft">
  
  <!-- üéöÔ∏è Transport Controls - Estilo Premium -->
  <div class="transport-section glass-fast border border-white/30 rounded-xl p-4 mb-6">
    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
      
      <!-- ‚ñ∂Ô∏è Secci√≥n Principal de Transporte -->
      <div class="transport-main flex items-center gap-4">
        
        <!-- Play/Stop Button Premium -->
        <button (click)="togglePlayback()"
                class="play-btn-premium w-14 h-14 rounded-full border-2 flex items-center justify-center font-bold transition-all duration-100 transform active:scale-95"
                [class.playing]="playbackState().isPlaying">
          <div class="flex items-center justify-center">
            <span class="text-lg">{{ playbackState().isPlaying ? '‚è∏' : '‚ñ∂' }}</span>
          </div>
        </button>

        <!-- BPM Control Premium -->
        <div class="bpm-section glass-fast border border-white/20 rounded-lg p-3 min-w-[120px]">
          <label class="block text-xs font-bold text-vynl-cloud/70 mb-1 tracking-wide uppercase">BPM</label>
          <div class="flex items-center gap-2">
            <input type="number" 
                   min="60" max="200" 
                   [(ngModel)]="tempBPM" 
                   (change)="updateBPM()"
                   class="bpm-input-premium w-16 bg-transparent text-xl font-bold text-vynl-steel text-center border-none outline-none">
            <div class="bpm-tap-btn w-8 h-8 rounded-full bg-vynl-slate/30 flex items-center justify-center cursor-pointer hover:bg-vynl-slate/50 transition-colors"
                 title="Tap Tempo">
              <span class="text-xs font-bold">TAP</span>
            </div>
          </div>
        </div>

        <!-- Step Indicator Premium -->
        <div class="step-indicator-premium glass-fast border border-white/20 rounded-lg p-3">
          <label class="block text-xs font-bold text-vynl-cloud/70 mb-1 tracking-wide uppercase">Current Step</label>
          <div class="flex items-center gap-2">
            <div class="step-display-premium w-10 h-8 bg-vynl-cloud text-vynl-white rounded-md flex items-center justify-center font-mono font-bold">
              {{ playbackState().currentStep + 1 }}
            </div>
            <span class="text-xs text-vynl-cloud">/ 16</span>
          </div>
        </div>
      </div>

      <!-- üéöÔ∏è Secci√≥n de Controles Globales -->
      <div class="global-controls-section flex items-center gap-4">
        
        <!-- Swing Control Premium -->
        <div class="swing-control-premium glass-fast border border-white/20 rounded-lg p-3 min-w-[100px]">
          <label class="block text-xs font-bold text-vynl-cloud/70 mb-2 tracking-wide uppercase">Swing</label>
          <div class="flex items-center gap-2">
            <input type="range" 
                   min="0" max="100" 
                   [(ngModel)]="tempSwing" 
                   (input)="updateSwing()"
                   class="swing-slider flex-1 h-2 bg-vynl-slate/30 rounded-full outline-none cursor-pointer">
            <span class="text-xs font-bold text-vynl-cloud w-8 text-right">{{ tempSwing() }}%</span>
          </div>
        </div>

        <!-- Humanize Control -->
        <div class="humanize-control-premium glass-fast border border-white/20 rounded-lg p-3 min-w-[100px]">
          <label class="block text-xs font-bold text-vynl-cloud/70 mb-2 tracking-wide uppercase">Human</label>
          <div class="flex items-center gap-2">
            <input type="range" 
                   min="0" max="100" 
                   [(ngModel)]="tempHumanize" 
                   (input)="updateHumanize()"
                   class="humanize-slider flex-1 h-2 bg-vynl-slate/30 rounded-full outline-none cursor-pointer">
            <span class="text-xs font-bold text-vynl-cloud w-8 text-right">{{ tempHumanize() }}%</span>
          </div>
        </div>

        <!-- Advanced Toggle Premium -->
        <button (click)="showAdvancedControls.set(!showAdvancedControls())"
                class="advanced-btn glass-fast border border-white/20 px-4 py-3 rounded-lg text-xs font-bold tracking-wide transition-all duration-100 hover:border-white/40 text-vynl-cloud"
                [class.active]="showAdvancedControls()">
          {{ showAdvancedControls() ? 'BASIC' : 'ADVANCED' }}
        </button>
      </div>
    </div>
  </div>

  <!-- üéπ Sequencer Grid Principal -->
  <div class="sequencer-main glass-fast border border-white/20 rounded-xl overflow-hidden">
    
    <!-- Header Grid con Steps -->
    <div class="steps-header bg-vynl-carbon/5 border-b border-white/20 p-3">
      <div class="flex">
        <!-- Track Labels Column -->
        <div class="w-48 flex items-center justify-center">
          <h3 class="text-sm font-bold text-vynl-white tracking-wide uppercase">Sample Tracks</h3>
        </div>
        
        <!-- Steps Numbers -->
        <div class="flex-1 grid grid-cols-16 gap-1">
          @for (stepNum of stepNumbers(); track stepNum) {
            <div class="step-number h-8 flex items-center justify-center text-xs font-mono font-bold text-vynl-cloud rounded-md"
                 [class.current-step-header]="playbackState().currentStep === stepNum - 1 && playbackState().isPlaying"
                 [class.beat-strong]="stepNum === 1 || stepNum === 5 || stepNum === 9 || stepNum === 13"
                 [class.beat-weak]="stepNum !== 1 && stepNum !== 5 && stepNum !== 9 && stepNum !== 13">
              {{ stepNum }}
            </div>
          }
        </div>
      </div>
    </div>

    <!-- Tracks Container -->
    <div class="tracks-container max-h-96 overflow-y-auto">
      @for (track of tracksWithSampleNames(); track trackByTrackId($index, track)) {
        <div class="track-row-premium border-b border-white/10 transition-all duration-100"
             [class]="getTrackClass(track)"
             (click)="onTrackSelect(track.id)">
          
          <div class="flex">
            
            <!-- üéµ Track Info Premium -->
            <div class="track-info-premium w-48 p-3 glass-fast border-r border-white/10 flex items-center justify-between">
              
              <!-- Sample Info -->
              <div class="sample-section flex items-center gap-3">
                <!-- Pad Number -->
                <div class="pad-number w-8 h-8 rounded-lg flex items-center justify-center text-xs font-bold text-white"
                     [style.background]="track.color">
                  {{ track.padIndex + 1 }}
                </div>
                
                <!-- Sample Name & Status -->
                <div class="sample-details flex flex-col justify-center min-w-0">
                  <div class="sample-name text-sm font-bold text-vynl-carbon truncate max-w-24"
                       [class.has-sample]="track.hasAudio"
                       [title]="track.displayName">
                    {{ track.displayName }}
                  </div>
                  <div class="sample-status flex items-center gap-2">
                    <div *ngIf="track.hasAudio" class="status-dot w-2 h-2 bg-green-400 rounded-full"></div>
                    <span class="text-xs text-vynl-cloud/60 uppercase tracking-wide">
                      {{ track.hasAudio ? 'LOADED' : 'EMPTY' }}
                    </span>
                  </div>
                </div>
              </div>

              <!-- Track Controls -->
              <div class="track-controls flex items-center gap-2">
                <button (click)="onMuteToggle(track.id, $event)"
                        class="control-btn-mini w-6 h-6 rounded text-xs font-bold transition-all duration-100"
                        [class.active]="track.mute"
                        title="Mute Track">
                  M
                </button>
                <button (click)="onSoloToggle(track.id, $event)"
                        class="control-btn-mini w-6 h-6 rounded text-xs font-bold transition-all duration-100"
                        [class.active]="track.solo"
                        title="Solo Track">
                  S
                </button>
              </div>
            </div>

            <!-- üéπ Steps Grid Premium - MEJORADO -->
<div class="steps-section flex-1 p-3 grid grid-cols-16 gap-1">
  @for (step of track.steps; track trackByStepIndex($index, step)) {
    <button class="step-btn-premium relative w-7 h-8 rounded-md transition-all duration-100 cursor-pointer"
            [class]="getStepClass(track, $index)"
            [style.opacity]="getStepOpacity(step)"
            (click)="onStepClick(track.id, $index, $event)"
            (wheel)="onStepWheel(track.id, $index, $event)"
            [title]="getStepTooltip(step, $index)">
      
      <!-- Step Content Container -->
      <div class="step-content absolute inset-0 rounded-md overflow-hidden">
        
        <!-- Velocity Bar Mejorado -->
        <div *ngIf="step.isActive"
             class="velocity-bar absolute bottom-0 left-0 right-0 rounded-b-md transition-all duration-100"
             [style.height.%]="(step.velocity / 127) * 100">
        </div>
        
        <!-- Active Step Overlay -->
        <div *ngIf="step.isActive" 
             class="active-overlay absolute inset-0 rounded-md">
        </div>
        
        <!-- Step Number (solo en beats principales) -->
        <div *ngIf="($index + 1) % 4 === 1" 
             class="step-number absolute top-0.5 left-0.5 text-xs font-bold opacity-60">
          {{ $index + 1 }}
        </div>
        
        <!-- Probability Indicator Mejorado -->
        <div *ngIf="step.isActive && step.probability < 100"
             class="probability-indicator absolute top-0.5 right-0.5 w-1.5 h-1.5 rounded-full">
        </div>
        
        <!-- Pan Indicator -->
        <div *ngIf="step.isActive && step.pan !== 0"
             class="pan-indicator absolute bottom-0.5 right-0.5 w-1 h-1 rounded-full">
        </div>
      </div>
    </button>
  }
</div>
          </div>
        </div>
      }
    </div>
  </div>

  <!-- üéöÔ∏è Advanced Controls Panel -->
  @if (showAdvancedControls() && selectedTrackData() && selectedStepData()) {
    <div class="advanced-controls-premium glass-fast border border-white/20 rounded-xl p-6 mt-6">
      
      <!-- Header -->
      <div class="advanced-header flex items-center justify-between mb-6">
        <h3 class="text-lg font-bold text-vynl-carbon">
          Step Editor - {{ selectedTrackData()!.displayName }} 
          <span class="text-sm font-normal text-vynl-charcoal">Step {{ selectedStep()! + 1 }}</span>
        </h3>
        <button (click)="showAdvancedControls.set(false)"
                class="close-btn w-8 h-8 rounded-full bg-vynl-slate/20 hover:bg-vynl-slate/40 flex items-center justify-center transition-colors">
          ‚úï
        </button>
      </div>

      <!-- Controls Grid -->
      <div class="controls-grid grid grid-cols-2 lg:grid-cols-4 gap-6">
        
        <!-- Velocity -->
        <div class="control-section">
          <label class="control-label block text-sm font-bold text-vynl-carbon mb-3 tracking-wide uppercase">Velocity</label>
          <div class="control-wrapper glass-fast border border-white/20 rounded-lg p-4">
            <input type="range" 
                   min="0" max="127" 
                   [value]="selectedStepData()!.velocity"
                   (input)="sequencerService.updateStepVelocity(selectedTrackData()!.id, selectedStep()!, +$any($event.target).value)"
                   class="premium-slider w-full h-3 bg-vynl-slate/30 rounded-full mb-2">
            <div class="value-display text-center">
              <span class="text-lg font-bold text-vynl-carbon">{{ selectedStepData()!.velocity }}</span>
              <span class="text-xs text-vynl-charcoal ml-1">/127</span>
            </div>
          </div>
        </div>

        <!-- Pan -->
        <div class="control-section">
          <label class="control-label block text-sm font-bold text-vynl-carbon mb-3 tracking-wide uppercase">Pan</label>
          <div class="control-wrapper glass-fast border border-white/20 rounded-lg p-4">
            <input type="range" 
                   min="-100" max="100" 
                   [value]="selectedStepData()!.pan * 100"
                   (input)="sequencerService.updateStepPan(selectedTrackData()!.id, selectedStep()!, +$any($event.target).value / 100)"
                   class="premium-slider w-full h-3 bg-vynl-slate/30 rounded-full mb-2">
            <div class="value-display text-center">
              <span class="text-lg font-bold text-vynl-carbon">
                {{ selectedStepData()!.pan > 0 ? 'R' : selectedStepData()!.pan < 0 ? 'L' : 'C' }}{{ Math.abs(selectedStepData()!.pan * 100).toFixed(0) }}
              </span>
            </div>
          </div>
        </div>

        <!-- Probability -->
        <div class="control-section">
          <label class="control-label block text-sm font-bold text-vynl-carbon mb-3 tracking-wide uppercase">Chance</label>
          <div class="control-wrapper glass-fast border border-white/20 rounded-lg p-4">
            <input type="range" 
                   min="0" max="100" 
                   [value]="selectedStepData()!.probability"
                   class="premium-slider w-full h-3 bg-vynl-slate/30 rounded-full mb-2">
            <div class="value-display text-center">
              <span class="text-lg font-bold text-vynl-carbon">{{ selectedStepData()!.probability }}</span>
              <span class="text-xs text-vynl-charcoal ml-1">%</span>
            </div>
          </div>
        </div>

        <!-- Note Length -->
        <div class="control-section">
          <label class="control-label block text-sm font-bold text-vynl-carbon mb-3 tracking-wide uppercase">Length</label>
          <div class="control-wrapper glass-fast border border-white/20 rounded-lg p-4">
            <input type="range" 
                   min="10" max="400" 
                   [value]="selectedStepData()!.noteLength * 100"
                   class="premium-slider w-full h-3 bg-vynl-slate/30 rounded-full mb-2">
            <div class="value-display text-center">
              <span class="text-lg font-bold text-vynl-carbon">{{ (selectedStepData()!.noteLength * 100).toFixed(0) }}</span>
              <span class="text-xs text-vynl-charcoal ml-1">%</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Advanced Options -->
      <div class="advanced-options mt-6 flex flex-wrap items-center gap-6">
        
        <!-- Triplet -->
        <div class="option-control glass-fast border border-white/20 rounded-lg p-3">
          <label class="flex items-center gap-3 cursor-pointer">
            <input type="checkbox" 
                   [checked]="selectedStepData()!.triplet"
                   class="w-5 h-5 rounded accent-vynl-carbon">
            <span class="text-sm font-bold text-vynl-carbon uppercase tracking-wide">Triplet</span>
          </label>
        </div>

        <!-- Step Humanize -->
        <div class="option-control glass-fast border border-white/20 rounded-lg p-3 flex items-center gap-3">
          <label class="text-sm font-bold text-vynl-steel uppercase tracking-wide">Step Humanize</label>
          <input type="range" 
                 min="0" max="100" 
                 [value]="selectedStepData()!.humanize"
                 class="premium-slider w-20 h-2 bg-vynl-slate/30 rounded-full">
          <span class="text-sm font-bold text-vynl-carbon w-10 text-right">{{ selectedStepData()!.humanize }}%</span>
        </div>

        <!-- Step Swing -->
        <div class="option-control glass-fast border border-white/20 rounded-lg p-3 flex items-center gap-3">
          <label class="text-sm font-bold text-vynl-carbon uppercase tracking-wide">Step Swing</label>
          <input type="range" 
                 min="0" max="100" 
                 [value]="selectedStepData()!.swing"
                 class="premium-slider w-20 h-2 bg-vynl-slate/30 rounded-full">
          <span class="text-sm font-bold text-vynl-carbon w-10 text-right">{{ selectedStepData()!.swing }}%</span>
        </div>
      </div>
    </div>
  }
</div>